import{r as y,u as w,j as t,B as M,s as F,t as L,v as ne,w as $,x as C,y as S,d as G}from"./index-CjbR5zlf.js";import{C as N,c as re,f as A,U as q,B as H,F as W,h as I,T as ae,b as oe,d as k,e as V}from"./index-DbdGFxt5.js";import{u as P,D as J,a as X,f as ce}from"./data-table-row-actions-CWvKL5tc.js";import{z as D,u as Y,t as Z,F as U,a as b,b as f,c as x,d as R,e as Q}from"./form-BnLW7AoU.js";import{S as le,a as ue,b as de,c as ge}from"./select-CBNmlDFn.js";import{I as O}from"./input-number-nItHs7OP.js";import{d as _,a as c,u as me,b as ye,c as he,e as De}from"./district.query-keys-BAHsGDov.js";import{u as pe}from"./use-ui-action-label-D2tLhJmv.js";import{g as je}from"./get-select-options-BZMYMvLB.js";import"./vendor-CLh72Zqc.js";import"./eye-CfiRFG4z.js";const ee=y.memo(({title:e,activeTab:s,onAddRegion:n,onAddDistrict:i})=>{const{t:r}=w("common");return t.jsxs("div",{className:"flex justify-between",children:[t.jsx("h5",{className:"text-2xl font-semibold uppercase",children:e}),s==="regions"?t.jsxs(M,{onClick:n,children:[t.jsx(N,{}),r("actions.add_region")]}):t.jsxs(M,{onClick:i,children:[t.jsx(N,{})," ",r("actions.add_district")]})]})});ee.displayName="ActionButton";const T={fetchRegions:async e=>{const{data:s}=await F.getWithPagination(L.REGIONS,e);return s||[]},fetchRegion:async e=>{const{data:s}=await F.get(`${L.REGIONS}/${e}`);return s.data},createRegion:async e=>{const s=await F.post(L.REGIONS,e);return!s.success&&s.errors&&ne.error(Object.values(s.errors).join(", "),{richColors:!0}),s},updateRegion:async e=>{const s=await F.put(`${L.REGIONS}/${e.id}`,e);if(!s.success)throw new Error(s.message);return s},deleteRegion:async e=>{const s=await F.delete(`${L.REGIONS}/${e}`);if(!s.success)throw new Error(s.message)}},se=10*60*1e3,be=e=>$({staleTime:se,queryKey:a.list("region",e),queryFn:()=>T.fetchRegions(e),placeholderData:s=>s}),fe=(e,s)=>$({enabled:!!e,staleTime:se,queryFn:()=>T.fetchRegion(e),queryKey:a.detail("region",e),placeholderData:n=>n,...s}),K={name:D.string().min(1,"Viloyat nomi majburiy"),soato:D.coerce.string().min(1,"MHOBTni kiritish majburiy"),number:D.coerce.string().min(1,"Raqamni kiritish majburiy")},te=D.object({id:D.number().optional(),...K});D.object(K),D.object({id:D.number(),...Object.fromEntries(Object.entries(K).map(([e,s])=>[e,s.optional()]))}),D.object({...Object.fromEntries(Object.entries(K).map(([e,s])=>[e,s.optional()])),page:D.number().optional().default(1),size:D.number().optional().default(20)});const a=re("region"),xe=()=>{const e=C();return S({mutationFn:T.createRegion,onMutate:async s=>{await e.cancelQueries({queryKey:a.list("region")});const n=e.getQueryData(a.list("region"));if(n){const i={...s,id:-Date.now()};e.setQueryData(a.list("region"),{...n,content:[...n.content,i]})}return{previousRegionsList:n}},onSuccess:s=>{e.invalidateQueries({queryKey:a.list("region")}),e.setQueryData(a.detail("region",s.data.id),s)},onError:(s,n,i)=>{i?.previousRegionsList&&e.setQueryData(a.list("region"),i.previousRegionsList)}})},Re=()=>{const e=C();return S({mutationFn:T.updateRegion,onMutate:async s=>{if(!s.id)throw new Error("Cannot update region without ID");await e.cancelQueries({queryKey:a.detail("region",s.id)}),await e.cancelQueries({queryKey:a.list("region")});const n=e.getQueryData(a.detail("region",s.id)),i=e.getQueryData(a.list("region"));return e.setQueryData(a.detail("region",s.id),s),i&&e.setQueryData(a.list("region"),{...i,content:i.content.map(r=>r.id===s.id?s:r)}),{previousRegionDetail:n,previousRegionsList:i}},onSuccess:s=>{s.data.id&&e.setQueryData(a.detail("region",s.data.id),s),e.invalidateQueries({queryKey:a.list("region")})},onError:(s,n,i)=>{i?.previousRegionDetail&&e.setQueryData(a.detail("region",n.id),i.previousRegionDetail),i?.previousRegionsList&&e.setQueryData(a.list("region"),i.previousRegionsList)}})},Qe=()=>{const e=C();return S({mutationFn:T.deleteRegion,onMutate:async s=>{await e.cancelQueries({queryKey:a.list("region")}),await e.cancelQueries({queryKey:a.detail("region",s)});const n=e.getQueryData(a.list("region")),i=e.getQueryData(a.detail("region",s));return n&&e.setQueryData(a.list("region"),{...n,content:n.content.filter(r=>r.id!==s)}),e.removeQueries({queryKey:a.detail("region",s)}),{previousRegionsList:n,previousRegionDetail:i}},onSuccess:()=>{e.invalidateQueries({queryKey:a.list("region")})},onError:(s,n,i)=>{i?.previousRegionDetail&&e.setQueryData(a.detail("region",n),i.previousRegionDetail),i?.previousRegionsList&&e.setQueryData(a.list("region"),i.previousRegionsList)}})};function ve(){const{filters:e}=P(),{onOpen:s}=A(),{t:n}=w("common"),{data:i,isLoading:r}=be(e),d=Qe(),o=l=>s(q.EDIT,{id:l}),h=l=>d.mutate(l),g=[{maxSize:20,accessorKey:"number",header:n("sequence_number"),cell:l=>l.row.index+1},{enablePinning:!0,accessorKey:"name",enableSorting:!1,header:n("name")},{accessorKey:"soato",header:n("region_code")},{id:"actions",maxSize:40,enableResizing:!1,cell:({row:l})=>t.jsx(J,{showEdit:!0,row:l,showDelete:!0,onEdit:u=>o(u.original.id),onDelete:u=>h(u.original.id)})}];return t.jsx(X,{isPaginated:!0,data:i||[],isLoading:r,columns:g,className:"h-[calc(100svh-270px)]"})}const z={name:"",soato:"",number:""};function we(){const{mode:e,data:s,onClose:n}=A(),i=e===q.CREATE,r=y.useMemo(()=>s?.id?s?.id:0,[s]),d=Y({resolver:Z(te),defaultValues:z,mode:"onChange"}),{mutateAsync:o,isPending:h}=xe(),{mutateAsync:g,isPending:l}=Re(),{data:u,isLoading:p}=fe(r,{enabled:!i&&r>0});y.useEffect(()=>{u&&!i&&d.reset(u)},[u,i,d]);const m=y.useCallback(()=>{d.reset(z),n()},[d,n]),v=y.useCallback(async E=>{try{if(i){if((await o(E)).success)return m(),!0}else if((await g({id:r,...E})).success)return m(),!0;return!1}catch(j){return console.error("[useDistrictForm] Submission error:",j),!1}},[i,r,o,g,m]);return{form:d,isCreate:i,isPending:h||l,regionData:u,onSubmit:v,isFetching:p}}const Ce=()=>{const{t:e}=w("common"),{isOpen:s,onClose:n}=A(),{form:i,onSubmit:r,isPending:d,isCreate:o,isFetching:h}=we();return t.jsx(H,{asForm:!0,open:s,onClose:n,loading:d,disabled:d,onSubmit:i.handleSubmit(r),title:e(o?"actions.add":"actions.edit"),children:t.jsx(U,{...i,children:t.jsx("div",{className:"space-y-4",children:h&&!o?t.jsx(W,{length:3}):t.jsxs(y.Fragment,{children:[t.jsx(b,{name:"name",control:i.control,render:({field:g})=>t.jsxs(f,{children:[t.jsx(x,{children:e("name")}),t.jsx(R,{children:t.jsx(G,{placeholder:e("name"),...g})}),t.jsx(Q,{})]})}),t.jsx(b,{name:"soato",control:i.control,render:({field:g})=>t.jsxs(f,{children:[t.jsx(x,{children:e("soato")}),t.jsx(R,{children:t.jsx(O,{placeholder:e("soato"),...g})}),t.jsx(Q,{})]})}),t.jsx(b,{name:"number",control:i.control,render:({field:g})=>t.jsxs(f,{children:[t.jsx(x,{children:e("number")}),t.jsx(R,{children:t.jsx(O,{placeholder:e("number"),...g})}),t.jsx(Q,{})]})})]})})})})},Se=()=>{const{filters:e,setFilters:s}=P({"active-tab":ce.string("regions")}),{onOpen:n,isOpen:i}=A(),{onOpen:r,isOpen:d}=I(),o=y.useMemo(()=>e["active-tab"],[e]),h=y.useCallback(u=>s(p=>({...p,"active-tab":u})),[s]),g=y.useCallback(()=>{n(q.CREATE)},[n]),l=y.useCallback(()=>{r(q.CREATE)},[r]);return{filters:e,activeTab:o,isOpenRegion:i,isOpenDistrict:d,handleChangeTab:h,openAddRegionDrawer:g,openAddDistrictDrawer:l}},Ee=()=>{const e=C();return S({mutationFn:_.createDistrict,onMutate:async s=>{await e.cancelQueries({queryKey:c.list("district")});const n=e.getQueryData(c.list("district"));if(n){const i={...s,id:-Date.now()};e.setQueryData(c.list("district"),{...n,content:[...n.content,i]})}return{previousDistrictsList:n}},onSuccess:s=>{e.invalidateQueries({queryKey:c.list("district")}),e.setQueryData(c.detail("district",s.data.id),s)},onError:(s,n,i)=>{i?.previousDistrictsList&&e.setQueryData(c.list("district"),i.previousDistrictsList)}})},Fe=()=>{const e=C();return S({mutationFn:_.updateDistrict,onMutate:async s=>{if(!s.id)throw new Error("Cannot update district without ID");await e.cancelQueries({queryKey:c.detail("district",s.id)}),await e.cancelQueries({queryKey:c.list("district")});const n=e.getQueryData(c.detail("district",s.id)),i=e.getQueryData(c.list("district"));return e.setQueryData(c.detail("district",s.id),s),i&&e.setQueryData(c.list("district"),{...i,content:i.content.map(r=>r.id===s.id?s:r)}),{previousRegionDetail:n,previousDistrictsList:i}},onSuccess:s=>{s.data.id&&e.setQueryData(c.detail("district",s.data.id),s),e.invalidateQueries({queryKey:c.list("district")})},onError:(s,n,i)=>{i?.previousRegionDetail&&e.setQueryData(c.detail("district",n.id),i.previousRegionDetail),i?.previousDistrictsList&&e.setQueryData(c.list("district"),i.previousDistrictsList)}})},Le=()=>{const e=C();return S({mutationFn:_.deleteDistrict,onMutate:async s=>{await e.cancelQueries({queryKey:c.list("district")}),await e.cancelQueries({queryKey:c.detail("district",s)});const n=e.getQueryData(c.list("district")),i=e.getQueryData(c.detail("district",s));return n&&e.setQueryData(c.list("district"),{...n,content:n.content.filter(r=>r.id!==s)}),e.removeQueries({queryKey:c.detail("district",s)}),{previousDistrictsList:n,previousDistrictDetail:i}},onSuccess:()=>{e.invalidateQueries({queryKey:c.list("district")})},onError:(s,n,i)=>{i?.previousDistrictDetail&&e.setQueryData(c.detail("district",n),i.previousDistrictDetail),i?.previousDistrictsList&&e.setQueryData(c.list("district"),i.previousDistrictsList)}})};function qe(){const{filters:e}=P(),{onOpen:s}=I(),{t:n}=w("common"),i=Le(),{data:r,isLoading:d}=me(e),o=l=>s(q.EDIT,{id:l}),h=l=>i.mutate(l),g=[{maxSize:20,accessorKey:"number",header:n("sequence_number"),cell:l=>l.row.index+1},{enablePinning:!0,accessorKey:"name",enableSorting:!1,header:n("name")},{enablePinning:!0,accessorKey:"region",enableSorting:!1,header:n("region")},{accessorKey:"soato",header:n("district_code")},{id:"actions",maxSize:40,enableResizing:!1,cell:({row:l})=>t.jsx(J,{showEdit:!0,row:l,showDelete:!0,onEdit:u=>o(u.original.id),onDelete:u=>h(u.original.id)})}];return t.jsx(X,{isPaginated:!0,data:r||[],isLoading:d,columns:g,className:"h-[calc(100svh-270px)]"})}const B={name:"",soato:"",number:"",regionId:""};function Te(){const{data:e,onClose:s,isCreate:n}=I(),i=y.useMemo(()=>e?.id?e?.id:0,[e]),r=Y({resolver:Z(ye),defaultValues:B}),{data:d}=he(),{mutateAsync:o,isPending:h}=Ee(),{mutateAsync:g,isPending:l}=Fe(),{data:u,isLoading:p}=De(i);y.useEffect(()=>{u&&!n&&r.reset({...u,regionId:String(u.regionId)})},[u,r]);const m=y.useCallback(()=>{s(),r.reset(B)},[r,s]),v=y.useCallback(async E=>{try{if(n){if((await o(E)).success)return m(),!0}else if((await g({id:i,...E})).success)return m(),!0;return!1}catch(j){return console.error("[useDistrictForm] Submission error:",j),!1}},[n,i,o,g,m]);return{form:r,regions:d,isCreate:n,isPending:h||l,districtData:u,onSubmit:v,isFetching:p}}const Ke=()=>{const{t:e}=w("common"),{isOpen:s,onClose:n,mode:i,isCreate:r}=I(),d=pe(i),{form:o,onSubmit:h,isPending:g,isFetching:l,regions:u}=Te(),p=y.useMemo(()=>je(u),[u]);return t.jsx(H,{asForm:!0,open:s,onClose:n,title:d,loading:g,disabled:g,onSubmit:o.handleSubmit(h),children:t.jsx(U,{...o,children:t.jsx("div",{className:"space-y-4",children:l&&!r?t.jsx(W,{length:3}):t.jsxs(y.Fragment,{children:[t.jsx(b,{name:"regionId",control:o.control,render:({field:m})=>t.jsxs(f,{children:[t.jsx(x,{children:e("region")}),t.jsx(R,{children:t.jsxs(le,{...m,value:m.value,onValueChange:v=>{v&&(m.onChange(v),o.setValue("name",""),o.setValue("soato",""),o.setValue("number",""))},children:[t.jsx(ue,{children:t.jsx(de,{placeholder:e("select_region")})}),t.jsx(ge,{children:p})]})}),t.jsx(Q,{})]})}),t.jsx(b,{name:"name",control:o.control,render:({field:m})=>t.jsxs(f,{children:[t.jsx(x,{children:e("name")}),t.jsx(R,{children:t.jsx(G,{placeholder:e("name"),...m})}),t.jsx(Q,{})]})}),t.jsx(b,{name:"soato",control:o.control,render:({field:m})=>t.jsxs(f,{children:[t.jsx(x,{children:e("soato")}),t.jsx(R,{children:t.jsx(O,{maxLength:10,placeholder:e("soato"),...m})}),t.jsx(Q,{})]})}),t.jsx(b,{name:"number",control:o.control,render:({field:m})=>t.jsxs(f,{children:[t.jsx(x,{children:e("number")}),t.jsx(R,{children:t.jsx(O,{maxLength:10,placeholder:e("number"),...m})}),t.jsx(Q,{})]})})]})})})})},$e=()=>{const{t:e}=w("common"),{activeTab:s,isOpenRegion:n,isOpenDistrict:i,handleChangeTab:r,openAddRegionDrawer:d,openAddDistrictDrawer:o}=Se();return t.jsxs(y.Fragment,{children:[t.jsx(ee,{activeTab:s,title:e("menu.territories"),onAddRegion:d,onAddDistrict:o}),t.jsxs(ae,{className:"mt-3",defaultValue:s,onValueChange:h=>r(h),children:[t.jsxs(oe,{children:[t.jsx(k,{value:"regions",children:e("regions")}),t.jsx(k,{value:"districts",children:e("districts")})]}),t.jsx(V,{className:"mt-4",value:"regions",children:t.jsx(ve,{})}),t.jsx(V,{className:"mt-4",value:"districts",children:t.jsx(qe,{})})]}),n&&t.jsx(Ce,{}),i&&t.jsx(Ke,{})]})};export{$e as default};
