import{r as y,u as A,j as s,B as $,s as g,t as h,v as H,w as F,x as C,y as T,d as J}from"./index-CjbR5zlf.js";import{i as P,j as L,U as x,C as z,g as O,c as X,B as Y,F as Z,T as le,b as ce,d as B,e as V}from"./index-DbdGFxt5.js";import{u as U,f as ue,D as ee,a as te}from"./data-table-row-actions-CWvKL5tc.js";import{z as c,u as re,t as ae,F as se,a as I,b as K,c as _,d as N,e as M}from"./form-BnLW7AoU.js";import"./select-CBNmlDFn.js";import{M as pe}from"./multi-select-CI-sF_lY.js";import{c as de}from"./district.query-keys-BAHsGDov.js";import"./vendor-CLh72Zqc.js";import"./eye-CfiRFG4z.js";var f=(e=>(e.CENTRAL_APPARATUS="central-apparatus",e.TERRITORIAL_DEPARTMENTS="territorial-departments",e))(f||{});const me=()=>{const{filters:e,setFilters:t}=U({"active-tab":ue.string(f.CENTRAL_APPARATUS)}),{onOpen:a,isOpen:r}=P(),{onOpen:n,isOpen:p}=L(),u=y.useMemo(()=>e["active-tab"],[e]),d=y.useCallback(m=>t(b=>({...b,"active-tab":m})),[t]),D=y.useCallback(()=>{a(x.CREATE)},[a]),i=y.useCallback(()=>{n(x.CREATE)},[n]);return{filters:e,activeTab:u,onAddApparatus:D,onAddDepartment:i,handleChangeTab:d,isOpenCentralApparatus:r,isOpenTerritorialDepartments:p}},ne=y.memo(({title:e,activeTab:t,onAddApparatus:a,onAddDepartment:r})=>{const{t:n}=A("common");return s.jsxs("div",{className:"flex justify-between",children:[s.jsx("h5",{className:"text-2xl font-semibold uppercase",children:e}),t===f.CENTRAL_APPARATUS?s.jsxs($,{onClick:a,children:[s.jsx(z,{}),n("actions.add_central_apparatus")]}):s.jsxs($,{onClick:r,children:[s.jsx(z,{})," ",n("actions.add_territorial_department")]})]})});ne.displayName="DepartmentActionButton";const w={list:async e=>{const{data:t}=await g.getWithPagination(h.DEPARTMENTS,e);return t||[]},byId:async e=>{const{data:t}=await g.get(`${h.DEPARTMENTS}/${e}`);return t.data},create:async e=>{const t=await g.post(h.DEPARTMENTS,e);return!t.success&&t.errors&&H.error(Object.values(t.errors).join(", "),{richColors:!0}),t},update:async e=>{const t=await g.put(`${h.DEPARTMENTS}/${e.id}`,e);if(!t.success)throw new Error(t.message);return t},delete:async e=>{const t=await g.delete(`${h.DEPARTMENTS}/${e}`);if(!t.success)throw new Error(t.message)}},ye=e=>F({staleTime:O(1,"week"),queryKey:o.list("central-apparatus",e),queryFn:()=>w.list(e),placeholderData:t=>t}),De=(e,t)=>F({enabled:!!e,staleTime:O(1,"week"),queryFn:()=>w.byId(e),queryKey:o.detail("central-apparatus",e),placeholderData:a=>a,...t}),Q={name:c.string().min(1,"Viloyat nomi majburiy")},ie=c.object({id:c.number().optional(),...Q});c.object(Q),c.object({id:c.number(),...Object.fromEntries(Object.entries(Q).map(([e,t])=>[e,t.optional()]))}),c.object({...Object.fromEntries(Object.entries(Q).map(([e,t])=>[e,t.optional()])),page:c.number().optional().default(1),size:c.number().optional().default(20)});const o=X("central-apparatus"),ge=()=>{const e=C();return T({mutationFn:w.create,onMutate:async t=>{await e.cancelQueries({queryKey:o.list("central-apparatus")});const a=e.getQueryData(o.list("central-apparatus"));if(a){const r={...t,id:-Date.now()};e.setQueryData(o.list("central-apparatus"),{...a,content:[...a.content,r]})}return{previousList:a}},onSuccess:t=>{e.invalidateQueries({queryKey:o.list("central-apparatus")}),e.setQueryData(o.detail("central-apparatus",t.data.id),t)},onError:(t,a,r)=>{r?.previousList&&e.setQueryData(o.list("central-apparatus"),r.previousList)}})},he=()=>{const e=C();return T({mutationFn:w.update,onMutate:async t=>{if(!t.id)throw new Error("Cannot update central-apparatus without ID");await e.cancelQueries({queryKey:o.detail("central-apparatus",t.id)}),await e.cancelQueries({queryKey:o.list("central-apparatus")});const a=e.getQueryData(o.detail("central-apparatus",t.id)),r=e.getQueryData(o.list("central-apparatus"));return e.setQueryData(o.detail("central-apparatus",t.id),t),r&&e.setQueryData(o.list("central-apparatus"),{...r,content:r.content.map(n=>n.id===t.id?t:n)}),{previousDetail:a,previousList:r}},onSuccess:t=>{t.data.id&&e.setQueryData(o.detail("central-apparatus",t.data.id),t),e.invalidateQueries({queryKey:o.list("central-apparatus")})},onError:(t,a,r)=>{r?.previousDetail&&e.setQueryData(o.detail("central-apparatus",a.id),r.previousDetail),r?.previousList&&e.setQueryData(o.list("central-apparatus"),r.previousList)}})},be=()=>{const e=C();return T({mutationFn:w.delete,onMutate:async t=>{await e.cancelQueries({queryKey:o.list("central-apparatus")}),await e.cancelQueries({queryKey:o.detail("central-apparatus",t)});const a=e.getQueryData(o.list("central-apparatus")),r=e.getQueryData(o.detail("central-apparatus",t));return a&&e.setQueryData(o.list("central-apparatus"),{...a,content:a.content.filter(n=>n.id!==t)}),e.removeQueries({queryKey:o.detail("central-apparatus",t)}),{previousList:a,previousDetail:r}},onSuccess:()=>{e.invalidateQueries({queryKey:o.list("central-apparatus")})},onError:(t,a,r)=>{r?.previousDetail&&e.setQueryData(o.detail("central-apparatus",a),r.previousDetail),r?.previousList&&e.setQueryData(o.list("central-apparatus"),r.previousList)}})};function fe(){const{filters:e}=U(),{t}=A("common"),{onOpen:a}=P(),{data:r,isLoading:n}=ye(e),p=be(),u=i=>a(x.EDIT,{id:i}),d=i=>p.mutate(i),D=[{maxSize:20,accessorKey:"number",header:t("sequence_number"),cell:i=>i.row.index+1},{enablePinning:!0,accessorKey:"name",enableSorting:!1,header:t("name")},{id:"actions",maxSize:20,minSize:10,cell:({row:i})=>s.jsx(ee,{showEdit:!0,row:i,showDelete:!0,onEdit:m=>u(m.original.id),onDelete:m=>d(m.original.id)})}];return s.jsx(te,{isPaginated:!0,data:r||[],columns:D,isLoading:n,className:"h-[calc(100svh-270px)]"})}const W={name:""};function je(){const{data:e,onClose:t,isCreate:a}=P(),r=y.useMemo(()=>e?.id?e?.id:0,[e]),n=re({resolver:ae(ie),defaultValues:W,mode:"onChange"}),{mutateAsync:p,isPending:u}=ge(),{mutateAsync:d,isPending:D}=he(),{data:i,isLoading:m}=De(r);y.useEffect(()=>{i&&!a&&n.reset(i)},[i,a,n]);const b=y.useCallback(()=>{n.reset(W),t()},[n,t]),E=y.useCallback(async q=>{try{if(a){if((await p(q)).success)return b(),!0}else if((await d({id:r,...q})).success)return b(),!0;return!1}catch(j){return console.error("[useDistrictForm] Submission error:",j),!1}},[a,r,p,d,b]);return{form:n,isCreate:a,isPending:u||D,regionData:i,onSubmit:E,isFetching:m}}const Ae=()=>{const{t:e}=A("common"),{isOpen:t,onClose:a}=P(),{form:r,onSubmit:n,isPending:p,isCreate:u,isFetching:d}=je();return s.jsx(Y,{asForm:!0,open:t,onClose:a,loading:p,disabled:p,onSubmit:r.handleSubmit(n),title:e(u?"actions.add":"actions.edit"),children:s.jsx(se,{...r,children:s.jsx("div",{className:"space-y-4",children:d&&!u?s.jsx(Z,{length:1}):s.jsx(I,{name:"name",control:r.control,render:({field:D})=>s.jsxs(K,{children:[s.jsx(_,{children:e("name")}),s.jsx(N,{children:s.jsx(J,{placeholder:e("name"),...D})}),s.jsx(M,{})]})})})})})},v={list:async e=>{const{data:t}=await g.getWithPagination(h.OFFICES,e);return t||[]},byId:async e=>{const{data:t}=await g.get(`${h.OFFICES}/${e}`);return t.data},create:async e=>{const t=await g.post(h.OFFICES,e);return!t.success&&t.errors&&H.error(Object.values(t.errors).join(", "),{richColors:!0}),t},update:async e=>{const t=await g.put(`${h.OFFICES}/${e.id}`,e);if(!t.success)throw new Error(t.message);return t},delete:async e=>{const t=await g.delete(`${h.OFFICES}/${e}`);if(!t.success)throw new Error(t.message)}},Ce=e=>F({staleTime:O(1,"week"),queryKey:l.list("territorial-departments",e),queryFn:()=>v.list(e),placeholderData:t=>t}),Te=(e,t)=>F({enabled:!!e,staleTime:O(1,"week"),queryFn:()=>v.byId(e),queryKey:l.detail("territorial-departments",e),placeholderData:a=>a,...t}),S={name:c.string().min(1,"Nomi majburiy"),regionIds:c.array(c.number().int().positive())},oe=c.object({id:c.number().optional(),...S});c.object(S),c.object({id:c.number(),...Object.fromEntries(Object.entries(S).map(([e,t])=>[e,t.optional()]))}),c.object({...Object.fromEntries(Object.entries(S).map(([e,t])=>[e,t.optional()])),page:c.number().optional().default(1),size:c.number().optional().default(20)});const l=X("territorial-departments"),Ee=()=>{const e=C();return T({mutationFn:v.create,onMutate:async t=>{await e.cancelQueries({queryKey:l.list("territorial-departments")});const a=e.getQueryData(l.list("territorial-departments"));if(a){const r={...t,id:-Date.now()};e.setQueryData(l.list("territorial-departments"),{...a,content:[...a.content,r]})}return{previousList:a}},onSuccess:t=>{e.invalidateQueries({queryKey:l.list("territorial-departments")}),e.setQueryData(l.detail("territorial-departments",t.data.id),t)},onError:(t,a,r)=>{r?.previousList&&e.setQueryData(l.list("territorial-departments"),r.previousList)}})},we=()=>{const e=C();return T({mutationFn:v.update,onMutate:async t=>{if(!t.id)throw new Error("Cannot update territorial-departments without ID");await e.cancelQueries({queryKey:l.detail("territorial-departments",t.id)}),await e.cancelQueries({queryKey:l.list("territorial-departments")});const a=e.getQueryData(l.detail("territorial-departments",t.id)),r=e.getQueryData(l.list("territorial-departments"));return e.setQueryData(l.detail("territorial-departments",t.id),t),r&&e.setQueryData(l.list("territorial-departments"),{...r,content:r.content.map(n=>n.id===t.id?t:n)}),{previousDetail:a,previousList:r}},onSuccess:t=>{t.data.id&&e.setQueryData(l.detail("territorial-departments",t.data.id),t),e.invalidateQueries({queryKey:l.list("territorial-departments")})},onError:(t,a,r)=>{r?.previousDetail&&e.setQueryData(l.detail("territorial-departments",a.id),r.previousDetail),r?.previousList&&e.setQueryData(l.list("territorial-departments"),r.previousList)}})},ve=()=>{const e=C();return T({mutationFn:v.delete,onMutate:async t=>{await e.cancelQueries({queryKey:l.list("territorial-departments")}),await e.cancelQueries({queryKey:l.detail("territorial-departments",t)});const a=e.getQueryData(l.list("territorial-departments")),r=e.getQueryData(l.detail("territorial-departments",t));return a&&e.setQueryData(l.list("territorial-departments"),{...a,content:a.content.filter(n=>n.id!==t)}),e.removeQueries({queryKey:l.detail("territorial-departments",t)}),{previousList:a,previousDetail:r}},onSuccess:()=>{e.invalidateQueries({queryKey:l.list("territorial-departments")})},onError:(t,a,r)=>{r?.previousDetail&&e.setQueryData(l.detail("territorial-departments",a),r.previousDetail),r?.previousList&&e.setQueryData(l.list("territorial-departments"),r.previousList)}})};function Qe(){const{filters:e}=U(),{t}=A("common"),{onOpen:a}=L(),{data:r,isLoading:n}=Ce(e),p=ve(),u=i=>a(x.EDIT,{id:i}),d=i=>p.mutate(i),D=[{maxSize:20,accessorKey:"number",header:t("sequence_number"),cell:i=>i.row.index+1},{enablePinning:!0,accessorKey:"name",enableSorting:!1,header:t("name")},{enablePinning:!0,accessorKey:"regions",enableSorting:!1,header:t("regions")},{id:"actions",maxSize:20,minSize:10,cell:({row:i})=>s.jsx(ee,{showEdit:!0,row:i,showDelete:!0,onEdit:m=>u(m.original.id),onDelete:m=>d(m.original.id)})}];return s.jsx(te,{isPaginated:!0,data:r||[],columns:D,isLoading:n,className:"h-[calc(100svh-270px)]"})}const G={name:"",regionIds:[]};function Se(){const{data:e,onClose:t,isCreate:a}=L(),r=y.useMemo(()=>e?.id?e?.id:0,[e]),n=re({resolver:ae(oe),defaultValues:G,mode:"onChange"}),{data:p}=de(),{mutateAsync:u,isPending:d}=Ee(),{mutateAsync:D,isPending:i}=we(),{data:m,isLoading:b}=Te(r);y.useEffect(()=>{m&&!a&&n.reset(m)},[m,a,n]);const E=y.useCallback(()=>{n.reset(G),t()},[n,t]),k=y.useCallback(async j=>{try{if(a){if((await u(j)).success)return E(),!0}else if((await D({id:r,...j})).success)return E(),!0;return!1}catch(R){return console.error("[useDistrictForm] Submission error:",R),!1}},[a,r,u,D,E]);return{form:n,isPending:d||i,foundedData:m,regionOptions:p,onSubmit:k,isFetching:b}}const xe=()=>{const{t:e}=A("common"),{isOpen:t,onClose:a,isCreate:r}=L(),{form:n,onSubmit:p,isPending:u,isFetching:d,regionOptions:D}=Se();return s.jsx(Y,{asForm:!0,open:t,onClose:a,loading:u,disabled:u,onSubmit:n.handleSubmit(p),title:e(r?"actions.add":"actions.edit"),children:s.jsx(se,{...n,children:s.jsx("div",{className:"space-y-4",children:d&&!r?s.jsx(Z,{length:2}):s.jsxs(y.Fragment,{children:[s.jsx(I,{name:"name",control:n.control,render:({field:i})=>s.jsxs(K,{children:[s.jsx(_,{children:e("name")}),s.jsx(N,{children:s.jsx(J,{placeholder:e("name"),...i})}),s.jsx(M,{})]})}),s.jsx(I,{name:"regionIds",control:n.control,render:({field:i})=>s.jsxs(K,{children:[s.jsx(_,{children:e("region")}),s.jsx(N,{children:s.jsx(pe,{...i,options:D,placeholder:e("select_region")})}),s.jsx(M,{})]})})]})})})})},Fe=()=>{const{t:e}=A("common"),{activeTab:t,onAddApparatus:a,onAddDepartment:r,handleChangeTab:n,isOpenCentralApparatus:p,isOpenTerritorialDepartments:u}=me();return s.jsxs(y.Fragment,{children:[s.jsx(ne,{activeTab:t,title:e("menu.departments"),onAddApparatus:a,onAddDepartment:r}),s.jsxs(le,{className:"mt-3",defaultValue:t,onValueChange:d=>n(d),children:[s.jsxs(ce,{children:[s.jsx(B,{value:f.CENTRAL_APPARATUS,children:e("central_apparatus")}),s.jsx(B,{value:f.TERRITORIAL_DEPARTMENTS,children:e("territorial_departments")})]}),s.jsx(V,{className:"mt-4",value:f.CENTRAL_APPARATUS,children:s.jsx(fe,{})}),s.jsx(V,{className:"mt-4",value:f.TERRITORIAL_DEPARTMENTS,children:s.jsx(Qe,{})})]}),p&&s.jsx(Ae,{}),u&&s.jsx(xe,{})]})},Me=y.memo(Fe);export{Me as default};
